<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xác thực Điểm danh</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; box-sizing: border-box; }
        .container { background: white; padding: 30px 40px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); width: 100%; max-width: 680px; text-align: center; }
        h1 { color: #1c1e21; }
        h2 { color: #1877f2; font-size: 1.2em; margin-top: -10px; }
        p { color: #606770; line-height: 1.5; }
        #checkInButton { background-color: #1877f2; color: white; border: none; padding: 15px 30px; font-size: 18px; font-weight: bold; border-radius: 8px; cursor: pointer; transition: background-color: 0.3s; }
        #checkInButton:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        #checkInButton:hover:not(:disabled) { background-color: #166fe5; }
        #message { margin-top: 20px; padding: 12px; border-radius: 6px; font-weight: bold; display: none; }
        .success { background-color: #e9f5e9; color: #4b844b; }
        .error { background-color: #fbe9e7; color: #c83737; }
        .loading { background-color: #e7f3ff; color: #1877f2; }
        #formContainer { display: none; width: 100%; min-height: 500px; }
        #formContainer iframe { width: 100%; height: 500px; border: 1px solid #ccc; }
    </style>
</head>
<body>

<div class="container">
    <div id="checkInScreen">
        <h1>Xác thực để Điểm danh</h1>
        <h2 id="sessionTitle">Đang tải tên buổi học...</h2>
        <p>Để đảm bảo tính hợp lệ, hệ thống cần xác nhận vị trí và thiết bị của bạn. Vui lòng nhấn nút bên dưới và cho phép trình duyệt truy cập vị trí.</p>
        <button id="checkInButton" disabled>Vui lòng chờ</button>
        <div id="message"></div>
    </div>
    
    <div id="formContainer">
        </div>
</div>

<script>
    // =================================================================
    // ======================= CẤU HÌNH CỦA GIÁO VIÊN ====================
    // =================================================================
    
    // SỬ DỤNG LINK /pub MÀ BẠN ĐÃ CUNG CẤP
    const CONFIG_URL = 'https://raw.githubusercontent.com/tranthanhthangbmt/diem-danh-sv/main/DSDiemDanh.txt';

    const staticConfig = {
        SCHOOL_COORDINATES: { latitude: 12.7081219, longitude: 108.0691692 },
        MAX_DISTANCE_METERS: 500,
    };
    // =================================================================

    const checkInButton = document.getElementById('checkInButton');
    const messageDiv = document.getElementById('message');
    const formContainer = document.getElementById('formContainer');
    const checkInScreen = document.getElementById('checkInScreen');
    const sessionTitle = document.getElementById('sessionTitle');

    // Hàm lấy cấu hình từ link đã xuất bản
    async function fetchConfig() {
		try {
			const response = await fetch(CONFIG_URL, { cache: "no-cache" });
			if (!response.ok) throw new Error(`Lỗi mạng: ${response.statusText}`);

			// Đọc nội dung file TXT
			const text = await response.text();
			const lines = text.trim().split('\n').map(l => l.trim()).filter(Boolean);

			if (lines.length < 2) throw new Error('File TXT phải có ít nhất 2 dòng: tên buổi học và link form.');

			const sessionName = lines[lines.length - 2];
			const formUrl = lines[lines.length - 1];

			if (!formUrl.startsWith('http')) throw new Error('Dòng cuối không phải là link hợp lệ.');

			return { sessionName, formUrl };
		} catch (error) {
			throw new Error(`Không thể tải cấu hình. ${error.message}`);
		}
	}


    // Các hàm còn lại giữ nguyên
    function initializeApp(dynamicConfig) {
        sessionTitle.textContent = dynamicConfig.sessionName;
        checkInButton.textContent = 'Bắt đầu Điểm danh';
        checkInButton.disabled = false;
        checkInButton.addEventListener('click', () => handleCheckIn(dynamicConfig));
    }
    
    async function handleCheckIn(config) {
        checkInButton.disabled = true;
        checkInButton.textContent = 'Đang kiểm tra...';
        showMessage('', 'none');
        try {
            checkDevice(config.sessionName);
            const studentCoords = await getLocation();
            const distance = haversineDistance(staticConfig.SCHOOL_COORDINATES, studentCoords);
            if (distance > staticConfig.MAX_DISTANCE_METERS) {
                throw new Error(`Bạn đang ở cách trường ${Math.round(distance)} mét. Vị trí không hợp lệ.`);
            }
            showMessage(`Vị trí hợp lệ (${Math.round(distance)}m). Vui lòng điền form bên dưới.`, 'success');
            showGoogleForm(config.formUrl);
            markDeviceAsAttended(config.sessionName);
        } catch (error) {
            showMessage(error.message, 'error');
            checkInButton.disabled = false;
            checkInButton.textContent = 'Thử lại';
        }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        showMessage('Đang tải cấu hình buổi học...', 'loading');
        fetchConfig()
            .then(initializeApp)
            .catch(error => {
                showMessage(error.message, 'error');
                sessionTitle.textContent = "Lỗi cấu hình";
                checkInButton.textContent = 'Không thể điểm danh';
            });
    });

    function checkDevice(sessionName) {
        const key = `attendance_${sessionName}`;
        if (localStorage.getItem(key)) throw new Error('Thiết bị này đã được dùng để điểm danh cho buổi học này.');
    }

    function markDeviceAsAttended(sessionName) {
        localStorage.setItem(`attendance_${sessionName}`, new Date().toISOString());
    }

    function getLocation() {
        return new Promise((resolve, reject) => {
            if (!navigator.geolocation) return reject(new Error('Trình duyệt không hỗ trợ định vị.'));
            navigator.geolocation.getCurrentPosition(
                (position) => resolve(position.coords),
                () => reject(new Error('Không thể lấy vị trí. Vui lòng cho phép truy cập và thử lại.')),
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        });
    }

    function haversineDistance(coords1, coords2) {
        const R = 6371e3;
        const lat1 = coords1.latitude * Math.PI / 180;
        const lat2 = coords2.latitude * Math.PI / 180;
        const deltaLat = (coords2.latitude - coords1.latitude) * Math.PI / 180;
        const deltaLon = (coords2.longitude - coords1.longitude) * Math.PI / 180;
        const a = Math.sin(deltaLat / 2) ** 2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(deltaLon / 2) ** 2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    function showGoogleForm(formUrl) {
        checkInScreen.style.display = 'none';
        const iframe = document.createElement('iframe');
        iframe.src = formUrl;
        iframe.frameBorder = '0';
        formContainer.appendChild(iframe);
        formContainer.style.display = 'block';
    }

    function showMessage(msg, type) {
        messageDiv.textContent = msg;
        messageDiv.className = type;
        messageDiv.style.display = msg ? 'block' : 'none';
    }
</script>

</body>
</html>