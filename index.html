<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>X√°c th·ª±c ƒêi·ªÉm danh ‚Äî B·∫£n chi ti·∫øt</title>
  <style>
    :root {
      --primary: #1877f2;
      --primary-dark: #166fe5;
      --text: #1c1e21;
      --muted: #555;
      --bg: #f5f7fb;
      --success-bg: #eaf7ea;
      --success: #2f7a2f;
      --error-bg: #fdebea;
      --error: #b42318;
      --loading-bg: #e7f1ff;
      --loading: #1a66ff;
      --border: #e5e7eb;
      --card: #fff;
    }
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 80% -10%, #eef3ff, transparent), var(--bg);
      margin: 0;
      padding: 24px;
      min-height: 100vh;
      display: grid;
      place-items: center;
    }
    .container {
      width: 100%;
      max-width: 820px;
      background: var(--card);
      border-radius: 16px;
      box-shadow: 0 10px 35px rgba(0,0,0,.08);
      padding: 28px 28px 20px;
    }
    header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }
    .logo {
      width: 40px; height: 40px; display: grid; place-items: center;
      border-radius: 10px; background: #eef3ff; color: var(--primary); font-weight: 800;
    }
    h1 { margin: 0; font-size: 20px; color: var(--text); }
    h2 { margin: 6px 0 12px; font-size: 16px; color: var(--primary); }
    p  { margin: 0 0 12px; color: var(--muted); line-height: 1.6; }
    .meta {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px; margin: 12px 0 18px;
    }
    .chip {
      border: 1px dashed var(--border);
      border-radius: 999px;
      padding: 8px 12px;
      display: inline-flex; align-items: center; gap: 8px;
      font-weight: 600; color: #333; background: #fafafa;
    }
    .row { display: grid; gap: 12px; }
    button.primary {
      background: var(--primary); color: #fff; border: none;
      padding: 14px 22px; border-radius: 10px; font-weight: 700; font-size: 16px;
      cursor: pointer; transition: background .2s, opacity .2s;
    }
    button.primary:hover:not(:disabled) { background: var(--primary-dark); }
    button.primary:disabled { opacity: .6; cursor: not-allowed; }
    #message {
      margin-top: 14px; padding: 12px 14px; border-radius: 10px;
      display: none; border: 1px solid var(--border); font-weight: 600;
      white-space: pre-line;
    }
    .success { background: var(--success-bg); color: var(--success); }
    .error { background: var(--error-bg); color: var(--error); }
    .loading { background: var(--loading-bg); color: var(--loading); }
    #formContainer { display: none; width: 100%; min-height: 540px; margin-top: 12px; }
    #formContainer iframe { width: 100%; height: 540px; border: 1px solid var(--border); border-radius: 12px; }
    details {
      margin-top: 10px; border: 1px solid var(--border); border-radius: 12px; padding: 12px 14px; background: #fcfcfd;
    }
    details summary { cursor: pointer; font-weight: 700; color: #333; }
    code.kbd {
      background: #eef3ff; border: 1px solid #d9e3ff; color: #1b3d9b; padding: 2px 6px; border-radius: 6px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 13px;
    }
    footer { margin-top: 16px; font-size: 12px; color: #667; }
    @media (max-width: 600px) {
      .meta { grid-template-columns: 1fr; }
      .container { padding: 22px 18px; }
    }
  </style>
</head>
<body>
  <main class="container">
    <header>
      <div class="logo">DD</div>
      <div>
        <h1>X√°c th·ª±c ƒë·ªÉ ƒêi·ªÉm danh</h1>
        <h2 id="sessionTitle">ƒêang t·∫£i t√™n bu·ªïi h·ªçc...</h2>
      </div>
    </header>

    <section class="row">
      <div class="meta">
        <div class="chip">‚è±Ô∏è Cooldown: <span id="cooldownLabel" style="margin-left:6px;font-weight:800;">30 ph√∫t</span></div>
        <div class="chip">üìç B√°n k√≠nh: <span id="radiusLabel" style="margin-left:6px;font-weight:800;">500 m</span></div>
        <div class="chip">üîí Tr√¨nh duy·ªát: <span id="browserLabel" style="margin-left:6px;font-weight:800;">ƒêang ki·ªÉm tra‚Ä¶</span></div>
      </div>
      
      <p>ƒê·ªÉ ƒë·∫£m b·∫£o t√≠nh h·ª£p l·ªá, h·ªá th·ªëng c·∫ßn x√°c nh·∫≠n v·ªã tr√≠ v√† thi·∫øt b·ªã c·ªßa b·∫°n. Vui l√≤ng nh·∫•n n√∫t b√™n d∆∞·ªõi v√† cho ph√©p tr√¨nh duy·ªát truy c·∫≠p v·ªã tr√≠.</p>
      <button id="checkInButton" class="primary" disabled>Vui l√≤ng ch·ªù</button>
      <div id="message"></div>

      <details>
        <summary>‚ö†Ô∏è N·∫øu th·∫•y th√¥ng b√°o ‚ÄúThis site can‚Äôt ask for your permission‚Äù</summary>
        <p style="margin-top:8px;">
          ƒê√¢y l√† l·ªói Chrome Android khi c√≥ ·ª©ng d·ª•ng kh√°c <b>ƒëang ph·ªß l·ªõp n·ªïi (overlay)</b> l√™n m√†n h√¨nh.<br/>
          C√°ch kh·∫Øc ph·ª•c nhanh:
          <br>‚Ä¢ T·∫Øt bong b√≥ng chat (Messenger/Zalo), tr√¨nh ghi m√†n h√¨nh, tr√¨nh ch·ªânh m√†u, c·ª≠a s·ªï n·ªïi.
          <br>‚Ä¢ V√†o <code class="kbd">C√†i ƒë·∫∑t ‚Üí ·ª®ng d·ª•ng ‚Üí Quy·ªÅn ƒë·∫∑c bi·ªát ‚Üí Hi·ªÉn th·ªã tr√™n ·ª©ng d·ª•ng kh√°c</code> v√† t·∫Øt t·∫°m quy·ªÅn n√†y cho c√°c ·ª©ng d·ª•ng hay n·ªïi.
          <br>‚Ä¢ Ki·ªÉm tra <code class="kbd">C√†i ƒë·∫∑t Chrome ‚Üí Quy·ªÅn trang web ‚Üí V·ªã tr√≠</code> v√† chuy·ªÉn sang <b>Cho ph√©p</b>, b·∫≠t <b>V·ªã tr√≠ ch√≠nh x√°c (Precise)</b>.
          <br>‚Ä¢ Sau ƒë√≥ t·∫£i l·∫°i trang v√† b·∫•m ‚ÄúB·∫Øt ƒë·∫ßu ƒêi·ªÉm danh‚Äù.
        </p>
      </details>
    </section>

    <section id="formContainer"></section>

    <footer>
      <span id="diag"></span>
    </footer>
  </main>

  <script>
    // ======================= C·∫§U H√åNH =======================
    const CONFIG_URL = 'https://raw.githubusercontent.com/tranthanhthangbmt/diem-danh-sv/main/DSDiemDanh.txt';
    const staticConfig = {
      SCHOOL_COORDINATES: { latitude: 12.7081219, longitude: 108.0691692 },
      MAX_DISTANCE_METERS: 500
    };
    const COOLDOWN_MINUTES = 180;
    const COOLDOWN_MS = COOLDOWN_MINUTES * 60 * 1000;

    // ======================= DOM =======================
    const checkInButton  = document.getElementById('checkInButton');
    const messageDiv     = document.getElementById('message');
    const formContainer  = document.getElementById('formContainer');
    const sessionTitle   = document.getElementById('sessionTitle');
    const cooldownLabel  = document.getElementById('cooldownLabel');
    const radiusLabel    = document.getElementById('radiusLabel');
    const browserLabel   = document.getElementById('browserLabel');
    const diag           = document.getElementById('diag');

    cooldownLabel.textContent = COOLDOWN_MINUTES + ' ph√∫t';
    radiusLabel.textContent   = staticConfig.MAX_DISTANCE_METERS + ' m';
    browserLabel.textContent  = navigator.userAgent.includes('Chrome') ? 'Chrome' : navigator.userAgent;

    // ======================= UI Helpers =======================
    function showMessage(msg, type) {
      messageDiv.textContent = msg;
      messageDiv.className = type || '';
      messageDiv.style.display = msg ? 'block' : 'none';
    }
    function msToMinSec(ms) {
      const m = Math.floor(ms / 60000);
      const s = Math.floor((ms % 60000) / 1000);
      return { m, s };
    }
    function formatMinSec(ms) {
      const { m, s } = msToMinSec(ms);
      return m + ':' + String(s).padStart(2, '0');
    }

    // ======================= Load Config TXT =======================
    async function fetchConfig() {
      const response = await fetch(CONFIG_URL, { cache: 'no-cache' });
      const text = await response.text();
      const lines = text.replace(/\r\n/g, '\n').split('\n').map(l => l.trim()).filter(Boolean);

      let sessionName, formUrl;
      if (lines[lines.length - 1].includes('formUrl=') || lines[lines.length - 2].includes('sessionName=')) {
        const kv = Object.fromEntries(
          lines.slice(-2).map(line => {
            const [k, ...rest] = line.split('=');
            return [k.trim(), rest.join('=').trim()];
          })
        );
        sessionName = kv.sessionName || kv.session || '';
        formUrl     = kv.formUrl     || kv.form    || '';
      } else {
        sessionName = lines[lines.length - 2];
        formUrl     = lines[lines.length - 1];
      }
      return { sessionName, formUrl };
    }

    // ======================= Cooldown =======================
    function getAttendanceKey(sessionName) { return 'attendance_' + sessionName; }
    function checkDevice(sessionName) {
      const key = getAttendanceKey(sessionName);
      const lastISO = localStorage.getItem(key);
      if (!lastISO) return;
      const remaining = COOLDOWN_MS - (Date.now() - Date.parse(lastISO));
      if (remaining > 0) {
        const { m, s } = msToMinSec(remaining);
        throw new Error('Thi·∫øt b·ªã ƒë√£ ƒëi·ªÉm danh. Vui l√≤ng th·ª≠ l·∫°i sau ' + m + ' ph√∫t ' + s + ' gi√¢y.');
      }
    }
    function markDeviceAsAttended(sessionName) {
      localStorage.setItem(getAttendanceKey(sessionName), new Date().toISOString());
    }

    // ======================= Geo Permission =======================
    async function ensureGeoPermission() {
      if (!('permissions' in navigator)) return 'unknown';
      try {
        const status = await navigator.permissions.query({ name: 'geolocation' });
        if (status.state === 'granted') return 'granted';
        if (status.state === 'denied') {
          throw new Error(
            'Tr√¨nh duy·ªát ƒëang CH·∫∂N quy·ªÅn v·ªã tr√≠.\n' +
            '‚Ä¢ T·∫Øt bong b√≥ng chat/·ª©ng d·ª•ng ƒëang ph·ªß m√†n h√¨nh.\n' +
            '‚Ä¢ M·ªü kho√° quy·ªÅn V·ªã tr√≠ cho Chrome, b·∫≠t ‚ÄúV·ªã tr√≠ ch√≠nh x√°c‚Äù.'
          );
        }
        return 'prompt';
      } catch { return 'unknown'; }
    }

    function getLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) return reject(new Error('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã.'));
        navigator.geolocation.getCurrentPosition(
          (pos) => resolve(pos.coords),
          () => reject(new Error('Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠. H√£y t·∫Øt overlay v√† b·∫≠t quy·ªÅn V·ªã tr√≠ cho Chrome.')),
          { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
        );
      });
    }

    function haversineDistance(a, b) {
      const R = 6371e3;
      const lat1 = a.latitude * Math.PI / 180;
      const lat2 = b.latitude * Math.PI / 180;
      const dLat = (b.latitude - a.latitude) * Math.PI / 180;
      const dLon = (b.longitude - a.longitude) * Math.PI / 180;
      const s = Math.sin(dLat/2)**2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon/2)**2;
      return 2 * R * Math.atan2(Math.sqrt(s), Math.sqrt(1 - s));
    }

    // ======================= Show Form =======================
    function showGoogleForm(formUrl) {
      document.querySelector('section.row').style.display = 'none';
      formContainer.innerHTML = '<iframe src="'+formUrl+'" frameborder="0"></iframe>';
      formContainer.style.display = 'block';
    }

    // ======================= Countdown =======================
    let countdownTimer = null;
    function startCountdown(msRemaining) {
      if (countdownTimer) clearInterval(countdownTimer);
      let t = msRemaining;
      checkInButton.disabled = true;
      showMessage('Thi·∫øt b·ªã ƒëang trong th·ªùi gian ch·ªù ƒëi·ªÉm danh l·∫°i.', 'loading');
      const tick = () => {
        if (t <= 0) {
          clearInterval(countdownTimer);
          checkInButton.disabled = false;
          checkInButton.textContent = 'B·∫Øt ƒë·∫ßu ƒêi·ªÉm danh';
          showMessage('', '');
          return;
        }
        checkInButton.textContent = 'Ch·ªù ' + formatMinSec(t) + ' ƒë·ªÉ ƒëi·ªÉm danh l·∫°i';
        t -= 1000;
      };
      tick(); countdownTimer = setInterval(tick, 1000);
    }

    function maybeStartCooldownCountdown(sessionName) {
      const lastISO = localStorage.getItem(getAttendanceKey(sessionName));
      if (!lastISO) return;
      const remaining = COOLDOWN_MS - (Date.now() - Date.parse(lastISO));
      if (remaining > 0) startCountdown(remaining);
    }

    // ======================= Main Flow =======================
    function initializeApp(cfg) {
      sessionTitle.textContent = cfg.sessionName;
      checkInButton.textContent = 'B·∫Øt ƒë·∫ßu ƒêi·ªÉm danh';
      checkInButton.disabled = false;
      checkInButton.onclick = () => handleCheckIn(cfg);
      maybeStartCooldownCountdown(cfg.sessionName);
    }

    async function handleCheckIn(cfg) {
      checkInButton.disabled = true;
      checkInButton.textContent = 'ƒêang ki·ªÉm tra...';
      showMessage('', '');
      try {
        checkDevice(cfg.sessionName);
        await ensureGeoPermission();
        const coords = await getLocation();
        const distance = Math.round(haversineDistance(staticConfig.SCHOOL_COORDINATES, coords));
        if (distance > staticConfig.MAX_DISTANCE_METERS)
          throw new Error('B·∫°n ƒëang ·ªü c√°ch tr∆∞·ªùng ' + distance + ' m√©t. V·ªã tr√≠ kh√¥ng h·ª£p l·ªá.');
        showMessage('V·ªã tr√≠ h·ª£p l·ªá (' + distance + 'm). Vui l√≤ng ƒëi·ªÅn form b√™n d∆∞·ªõi.', 'success');
        showGoogleForm(cfg.formUrl);
        markDeviceAsAttended(cfg.sessionName);
      } catch (err) {
        if (/th·ª≠ l·∫°i sau/i.test(err.message)) {
          const lastISO = localStorage.getItem(getAttendanceKey(cfg.sessionName));
          if (lastISO) {
            const remaining = COOLDOWN_MS - (Date.now() - Date.parse(lastISO));
            if (remaining > 0) startCountdown(remaining);
          }
        }
        showMessage(err.message || 'C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
        checkInButton.disabled = false;
        checkInButton.textContent = 'Th·ª≠ l·∫°i';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      showMessage('ƒêang t·∫£i c·∫•u h√¨nh bu·ªïi h·ªçc...', 'loading');
      fetchConfig().then(initializeApp).catch(err => {
        showMessage(err.message, 'error');
        sessionTitle.textContent = 'L·ªói c·∫•u h√¨nh';
        checkInButton.textContent = 'Kh√¥ng th·ªÉ ƒëi·ªÉm danh';
      });
    });
  </script>
</body>
</html>


