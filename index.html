<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xác thực Điểm danh</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; box-sizing: border-box; }
        .container { background: white; padding: 30px 40px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); width: 100%; max-width: 680px; text-align: center; }
        h1 { color: #1c1e21; }
        h2 { color: #1877f2; font-size: 1.2em; margin-top: -10px; }
        p { color: #606770; line-height: 1.5; }
        #checkInButton { background-color: #1877f2; color: white; border: none; padding: 15px 30px; font-size: 18px; font-weight: bold; border-radius: 8px; cursor: pointer; transition: background-color 0.3s; }
        #checkInButton:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        #checkInButton:hover:not(:disabled) { background-color: #166fe5; }
        #message { margin-top: 20px; padding: 12px; border-radius: 6px; font-weight: bold; display: none; }
        .success { background-color: #e9f5e9; color: #4b844b; }
        .error { background-color: #fbe9e7; color: #c83737; }
        .loading { background-color: #e7f3ff; color: #1877f2; }
        #formContainer { display: none; width: 100%; min-height: 500px; }
        #formContainer iframe { width: 100%; height: 500px; border: 1px solid #ccc; }
    </style>
</head>
<body>

<div class="container">
    <div id="checkInScreen">
        <h1>Xác thực để Điểm danh</h1>
        <h2 id="sessionTitle">Đang tải tên buổi học...</h2>
        <p>Để đảm bảo tính hợp lệ, hệ thống cần xác nhận vị trí và thiết bị của bạn. Vui lòng nhấn nút bên dưới và cho phép trình duyệt truy cập vị trí.</p>
        <button id="checkInButton" disabled>Vui lòng chờ</button>
        <div id="message"></div>
    </div>
    
    <div id="formContainer">
        </div>
</div>

<script>
    // =================================================================
    // ======================= CẤU HÌNH CỦA GIÁO VIÊN ====================
    // =================================================================
    
    // LINK ĐÃ ĐƯỢC SỬA LẠI CHO ĐÚNG
    const CONFIG_URL = 'https://docs.google.com/document/d/1q9d0YIYe9mlGiuZ6iS65WDN3a-QWy5fSmehrJt9uan4/export?format=txt';

    const staticConfig = {
        // Tọa độ của trường bạn
        SCHOOL_COORDINATES: {
            latitude: 12.7081219,
            longitude: 108.0691692
        },
        // Khoảng cách tối đa cho phép (mét)
        MAX_DISTANCE_METERS: 500,
    };
    // =================================================================

    const checkInButton = document.getElementById('checkInButton');
    const messageDiv = document.getElementById('message');
    const formContainer = document.getElementById('formContainer');
    const checkInScreen = document.getElementById('checkInScreen');
    const sessionTitle = document.getElementById('sessionTitle');

    // Hàm lấy cấu hình từ Google Doc
    async function fetchConfig() {
        try {
            // Thêm { cache: "no-cache" } để đảm bảo trình duyệt luôn tải file mới nhất
            const response = await fetch(CONFIG_URL, { cache: "no-cache" });
            if (!response.ok) {
                throw new Error(`Lỗi mạng: ${response.statusText}`);
            }
            const text = await response.text();
            
            // Phân tích văn bản để lấy 2 dòng cuối
            const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            
            if (lines.length < 2) {
                throw new Error('File Google Doc không có đủ 2 dòng nội dung.');
            }
            
            const sessionName = lines[lines.length - 2];
            const formUrl = lines[lines.length - 1];

            // Kiểm tra xem dòng cuối có phải là URL hợp lệ không
            if (!formUrl.startsWith('http')) {
                throw new Error('Dòng cuối cùng trong file Google Doc không phải là một đường link hợp lệ.');
            }

            return { sessionName, formUrl };

        } catch (error) {
            throw new Error(`Không thể tải cấu hình từ Google Doc. Vui lòng kiểm tra lại đường link và quyền chia sẻ. Lỗi: ${error.message}`);
        }
    }

    // Hàm khởi tạo ứng dụng sau khi có cấu hình
    function initializeApp(dynamicConfig) {
        sessionTitle.textContent = dynamicConfig.sessionName;
        checkInButton.textContent = 'Bắt đầu Điểm danh';
        checkInButton.disabled = false;

        checkInButton.addEventListener('click', () => handleCheckIn(dynamicConfig));
    }
    
    // Hàm chính xử lý khi nhấn nút
    async function handleCheckIn(config) {
        checkInButton.disabled = true;
        checkInButton.textContent = 'Đang kiểm tra...';
        showMessage('', 'none');

        try {
            // 1. Kiểm tra thiết bị dựa trên tên buổi học
            checkDevice(config.sessionName);

            // 2. Lấy vị trí và kiểm tra khoảng cách
            const studentCoords = await getLocation();
            const distance = haversineDistance(staticConfig.SCHOOL_COORDINATES, studentCoords);

            if (distance > staticConfig.MAX_DISTANCE_METERS) {
                throw new Error(`Bạn đang ở cách trường ${Math.round(distance)} mét. Vị trí không hợp lệ.`);
            }

            // 3. Nếu mọi thứ OK
            showMessage(`Vị trí hợp lệ (${Math.round(distance)}m). Vui lòng điền form bên dưới.`, 'success');
            showGoogleForm(config.formUrl);
            markDeviceAsAttended(config.sessionName);

        } catch (error) {
            showMessage(error.message, 'error');
            checkInButton.disabled = false;
            checkInButton.textContent = 'Thử lại';
        }
    }
    
    // Chạy khi trang được tải
    document.addEventListener('DOMContentLoaded', () => {
        showMessage('Đang tải cấu hình buổi học...', 'loading');
        fetchConfig()
            .then(dynamicConfig => {
                showMessage('', 'none'); // Xóa thông báo loading
                initializeApp(dynamicConfig);
            })
            .catch(error => {
                showMessage(error.message, 'error');
                sessionTitle.textContent = "Lỗi cấu hình";
                checkInButton.textContent = 'Không thể điểm danh';
            });
    });

    // --- CÁC HÀM HỖ TRỢ (Không thay đổi) ---

    function checkDevice(sessionName) {
        const key = `attendance_${sessionName}`;
        if (localStorage.getItem(key)) {
            throw new Error('Thiết bị này đã được dùng để điểm danh cho buổi học này.');
        }
    }

    function markDeviceAsAttended(sessionName) {
        const key = `attendance_${sessionName}`;
        localStorage.setItem(key, new Date().toISOString());
    }

    function getLocation() {
        return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
                reject(new Error('Trình duyệt không hỗ trợ định vị.'));
            }
            navigator.geolocation.getCurrentPosition(
                (position) => resolve({ latitude: position.coords.latitude, longitude: position.coords.longitude }),
                () => reject(new Error('Không thể lấy vị trí. Vui lòng cho phép truy cập và thử lại.')),
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        });
    }

    function haversineDistance(coords1, coords2) {
        const R = 6371e3;
        const lat1 = coords1.latitude * Math.PI / 180;
        const lat2 = coords2.latitude * Math.PI / 180;
        const deltaLat = (coords2.latitude - coords1.latitude) * Math.PI / 180;
        const deltaLon = (coords2.longitude - coords1.longitude) * Math.PI / 180;
        const a = Math.sin(deltaLat / 2) ** 2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(deltaLon / 2) ** 2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    function showGoogleForm(formUrl) {
        checkInScreen.style.display = 'none';