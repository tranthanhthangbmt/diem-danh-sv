<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>X√°c th·ª±c ƒêi·ªÉm danh</title>
  <style>
    :root {
      --primary: #1877f2;
      --primary-dark: #166fe5;
      --text: #1c1e21;
      --muted: #606770;
      --bg: #f0f2f5;
      --success-bg: #e9f5e9;
      --success: #4b844b;
      --error-bg: #fbe9e7;
      --error: #c83737;
      --loading-bg: #e7f3ff;
      --loading: #1877f2;
      --border: #e2e2e2;
    }
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg);
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      background: white;
      width: 100%;
      max-width: 720px;
      border-radius: 14px;
      padding: 32px 36px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.08);
    }
    h1 { color: var(--text); margin: 0 0 6px; }
    h2 { color: var(--primary); font-size: 1.1rem; margin: 0 0 16px; }
    p { color: var(--muted); line-height: 1.6; margin: 0 0 16px; }
    #checkInButton {
      display: inline-block;
      background-color: var(--primary);
      color: #fff;
      border: none;
      padding: 14px 22px;
      font-size: 16px;
      font-weight: 700;
      border-radius: 10px;
      cursor: pointer;
      transition: background-color .25s, opacity .25s;
    }
    #checkInButton:hover:not(:disabled) { background-color: var(--primary-dark); }
    #checkInButton:disabled { opacity: .6; cursor: not-allowed; }
    #message {
      margin-top: 14px;
      padding: 12px 14px;
      border-radius: 8px;
      font-weight: 600;
      display: none;
      border: 1px solid var(--border);
    }
    .success { background-color: var(--success-bg); color: var(--success); }
    .error { background-color: var(--error-bg); color: var(--error); }
    .loading { background-color: var(--loading-bg); color: var(--loading); }
    #formContainer { display: none; width: 100%; min-height: 520px; margin-top: 12px; }
    #formContainer iframe { width: 100%; height: 520px; border: 1px solid #ccc; border-radius: 10px; }
    .meta {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin: 8px 0 16px;
      color: #444;
      font-size: 14px;
    }
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px dashed var(--border);
      font-weight: 600;
    }
    .chip b { color: var(--text); }
    @media (max-width: 560px) {
      .meta { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="checkInScreen">
      <h1>X√°c th·ª±c ƒë·ªÉ ƒêi·ªÉm danh</h1>
      <h2 id="sessionTitle">ƒêang t·∫£i t√™n bu·ªïi h·ªçc...</h2>
      <div class="meta">
        <div class="chip"><span>‚è±Ô∏è Cooldown:</span> <b id="cooldownLabel">30 ph√∫t</b></div>
        <div class="chip"><span>üìç B√°n k√≠nh:</span> <b id="radiusLabel">500 m</b></div>
      </div>
      <p>ƒê·ªÉ ƒë·∫£m b·∫£o t√≠nh h·ª£p l·ªá, h·ªá th·ªëng c·∫ßn x√°c nh·∫≠n v·ªã tr√≠ v√† thi·∫øt b·ªã c·ªßa b·∫°n. Vui l√≤ng nh·∫•n n√∫t b√™n d∆∞·ªõi v√† cho ph√©p tr√¨nh duy·ªát truy c·∫≠p v·ªã tr√≠.</p>
      <button id="checkInButton" disabled>Vui l√≤ng ch·ªù</button>
      <div id="message"></div>
    </div>

    <div id="formContainer"></div>
  </div>

  <script>
    // =================================================================
    // ======================= C·∫§U H√åNH C·ª¶A GI√ÅO VI√äN ===================
    // =================================================================

    // 1) ƒê·ªçc c·∫•u h√¨nh t·ª´ file TXT tr√™n GitHub (d√πng link RAW)
    //    Quy ∆∞·ªõc: d√≤ng √°p ch√≥t = T√äN BU·ªîI H·ªåC, d√≤ng cu·ªëi = LINK GOOGLE FORM
    const CONFIG_URL = 'https://raw.githubusercontent.com/tranthanhthangbmt/diem-danh-sv/main/DSDiemDanh.txt';

    // 2) C·∫•u h√¨nh tƒ©nh: to·∫° ƒë·ªô & b√°n k√≠nh h·ª£p l·ªá (m)
    const staticConfig = {
      SCHOOL_COORDINATES: { latitude: 12.7081219, longitude: 108.0691692 },
      MAX_DISTANCE_METERS: 500
    };

    // 3) Th·ªùi gian ch·ªù (cooldown) cho M·ªñI BU·ªîI tr√™n M·ªñI THI·∫æT B·ªä
    const COOLDOWN_MINUTES = 30;
    const COOLDOWN_MS = COOLDOWN_MINUTES * 60 * 1000;

    // =================================================================

    const checkInButton = document.getElementById('checkInButton');
    const messageDiv = document.getElementById('message');
    const formContainer = document.getElementById('formContainer');
    const checkInScreen = document.getElementById('checkInScreen');
    const sessionTitle = document.getElementById('sessionTitle');
    const cooldownLabel = document.getElementById('cooldownLabel');
    const radiusLabel = document.getElementById('radiusLabel');

    cooldownLabel.textContent = COOLDOWN_MINUTES + ' ph√∫t';
    radiusLabel.textContent = staticConfig.MAX_DISTANCE_METERS + ' m';

    // ---------- Utils ----------
    function showMessage(msg, type) {
      messageDiv.textContent = msg;
      messageDiv.className = type || '';
      messageDiv.style.display = msg ? 'block' : 'none';
    }

    function msToMinSec(ms) {
      const m = Math.floor(ms / 60000);
      const s = Math.floor((ms % 60000) / 1000);
      return { m, s };
    }

    function formatMinSec(ms) {
      const { m, s } = msToMinSec(ms);
      return m + ':' + String(s).padStart(2, '0');
    }

    // ---------- ƒê·ªçc c·∫•u h√¨nh t·ª´ TXT ----------
    async function fetchConfig() {
      try {
        const response = await fetch(CONFIG_URL, { cache: 'no-cache' });
        if (!response.ok) throw new Error('L·ªói m·∫°ng: ' + response.status + ' ' + response.statusText);

        const text = await response.text();
        // Ch·∫•p nh·∫≠n c·∫£ \n (LF) l·∫´n \r\n (CRLF)
        const lines = text.replace(/\r\n/g, '\n').split('\n').map(l => l.trim()).filter(Boolean);

        if (lines.length < 2) throw new Error('File TXT ph·∫£i c√≥ √≠t nh·∫•t 2 d√≤ng: (d√≤ng √°p ch√≥t) t√™n bu·ªïi h·ªçc, (d√≤ng cu·ªëi) link form.');

        // H·ªó tr·ª£ 2 ƒë·ªãnh d·∫°ng:
        //  a) D√≤ng √°p ch√≥t = "T√™n bu·ªïi h·ªçc", d√≤ng cu·ªëi = "https://..."
        //  b) key=value: sessionName=..., formUrl=...
        let sessionName, formUrl;
        if (lines[lines.length - 1].includes('formUrl=') || lines[lines.length - 2].includes('sessionName=')) {
          const kv = Object.fromEntries(
            lines.slice(-2).map(line => {
              const [k, ...rest] = line.split('=');
              return [k.trim(), rest.join('=').trim()];
            })
          );
          sessionName = kv.sessionName || kv.session || '';
          formUrl = kv.formUrl || kv.form || '';
        } else {
          sessionName = lines[lines.length - 2];
          formUrl = lines[lines.length - 1];
        }

        if (!sessionName) throw new Error('Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c t√™n bu·ªïi h·ªçc t·ª´ file TXT.');
        if (!/^https?:\/\//i.test(formUrl)) throw new Error('D√≤ng cu·ªëi kh√¥ng ph·∫£i l√† link h·ª£p l·ªá.');

        return { sessionName, formUrl };
      } catch (error) {
        throw new Error('Kh√¥ng th·ªÉ t·∫£i c·∫•u h√¨nh. ' + error.message);
      }
    }

    // ---------- Ki·ªÉm tra thi·∫øt b·ªã & cooldown ----------
    function getAttendanceKey(sessionName) {
      return 'attendance_' + sessionName;
    }

    function checkDevice(sessionName) {
      const key = getAttendanceKey(sessionName);
      const lastISO = localStorage.getItem(key);
      if (!lastISO) return; // Ch∆∞a t·ª´ng ƒëi·ªÉm danh ‚Üí OK

      const lastTs = Date.parse(lastISO);
      const now = Date.now();
      const elapsed = now - lastTs;
      const remaining = COOLDOWN_MS - elapsed;

      if (remaining > 0) {
        const { m, s } = msToMinSec(remaining);
        throw new Error('Thi·∫øt b·ªã ƒë√£ ƒëi·ªÉm danh. Vui l√≤ng th·ª≠ l·∫°i sau ' + m + ' ph√∫t ' + s + ' gi√¢y.');
      }
    }

    function markDeviceAsAttended(sessionName) {
      localStorage.setItem(getAttendanceKey(sessionName), new Date().toISOString());
    }

    // ---------- ƒê·ªãnh v·ªã & kho·∫£ng c√°ch ----------
    function getLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) return reject(new Error('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã.'));
        navigator.geolocation.getCurrentPosition(
          (position) => resolve(position.coords),
          () => reject(new Error('Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠. Vui l√≤ng cho ph√©p truy c·∫≠p v√† th·ª≠ l·∫°i.')),
          { enableHighAccuracy: true, timeout: 12000, maximumAge: 0 }
        );
      });
    }

    function haversineDistance(coords1, coords2) {
      const R = 6371e3;
      const lat1 = coords1.latitude * Math.PI / 180;
      const lat2 = coords2.latitude * Math.PI / 180;
      const dLat = (coords2.latitude - coords1.latitude) * Math.PI / 180;
      const dLon = (coords2.longitude - coords1.longitude) * Math.PI / 180;
      const a = Math.sin(dLat/2) ** 2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon/2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // ---------- Hi·ªÉn th·ªã form ----------
    function showGoogleForm(formUrl) {
      checkInScreen.style.display = 'none';
      const iframe = document.createElement('iframe');
      iframe.src = formUrl;
      iframe.frameBorder = '0';
      formContainer.innerHTML = '';
      formContainer.appendChild(iframe);
      formContainer.style.display = 'block';
    }

    // ---------- ƒê·∫øm ng∆∞·ª£c tr√™n n√∫t khi c√≤n cooldown ----------
    let countdownTimer = null;
    function startCountdown(msRemaining) {
      if (countdownTimer) clearInterval(countdownTimer);
      let t = Math.max(0, msRemaining);
      checkInButton.disabled = true;
      showMessage('Thi·∫øt b·ªã ƒëang trong th·ªùi gian ch·ªù ƒëi·ªÉm danh l·∫°i.', 'loading');

      const tick = () => {
        if (t <= 0) {
          clearInterval(countdownTimer);
          checkInButton.disabled = false;
          checkInButton.textContent = 'B·∫Øt ƒë·∫ßu ƒêi·ªÉm danh';
          showMessage('', '');
          return;
        }
        checkInButton.textContent = 'Ch·ªù ' + formatMinSec(t) + ' ƒë·ªÉ ƒëi·ªÉm danh l·∫°i';
        t -= 1000;
      };

      tick();
      countdownTimer = setInterval(tick, 1000);
    }

    function maybeStartCooldownCountdown(sessionName) {
      const key = getAttendanceKey(sessionName);
      const lastISO = localStorage.getItem(key);
      if (!lastISO) return;
      const lastTs = Date.parse(lastISO);
      const remaining = COOLDOWN_MS - (Date.now() - lastTs);
      if (remaining > 0) startCountdown(remaining);
    }

    // ---------- Kh·ªüi t·∫°o ·ª©ng d·ª•ng ----------
    function initializeApp(dynamicConfig) {
      sessionTitle.textContent = dynamicConfig.sessionName;
      checkInButton.textContent = 'B·∫Øt ƒë·∫ßu ƒêi·ªÉm danh';
      checkInButton.disabled = false;
      checkInButton.onclick = () => handleCheckIn(dynamicConfig);
      // N·∫øu c√≤n cooldown, kho√° n√∫t & ch·∫°y ƒë·∫øm ng∆∞·ª£c ngay
      maybeStartCooldownCountdown(dynamicConfig.sessionName);
    }

    async function handleCheckIn(config) {
      checkInButton.disabled = true;
      checkInButton.textContent = 'ƒêang ki·ªÉm tra...';
      showMessage('', '');
      try {
        // 1) Ki·ªÉm tra cooldown theo thi·∫øt b·ªã & bu·ªïi
        checkDevice(config.sessionName);

        // 2) L·∫•y v·ªã tr√≠ v√† t√≠nh kho·∫£ng c√°ch
        const studentCoords = await getLocation();
        const distance = haversineDistance(staticConfig.SCHOOL_COORDINATES, studentCoords);
        if (distance > staticConfig.MAX_DISTANCE_METERS) {
          throw new Error('B·∫°n ƒëang ·ªü c√°ch tr∆∞·ªùng ' + Math.round(distance) + ' m√©t. V·ªã tr√≠ kh√¥ng h·ª£p l·ªá.');
        }

        // 3) Th√†nh c√¥ng ‚Üí m·ªü form & ƒë√°nh d·∫•u th·ªùi ƒëi·ªÉm
        showMessage('V·ªã tr√≠ h·ª£p l·ªá (' + Math.round(distance) + 'm). Vui l√≤ng ƒëi·ªÅn form b√™n d∆∞·ªõi.', 'success');
        showGoogleForm(config.formUrl);
        markDeviceAsAttended(config.sessionName);
      } catch (error) {
        // N·∫øu l·ªói do cooldown, kh·ªüi ƒë·ªông ƒë·∫øm ng∆∞·ª£c cho UX t·ªët h∆°n
        if (/th·ª≠ l·∫°i sau/i.test(error.message)) {
          const key = getAttendanceKey(config.sessionName);
          const lastISO = localStorage.getItem(key);
          if (lastISO) {
            const remaining = COOLDOWN_MS - (Date.now() - Date.parse(lastISO));
            if (remaining > 0) startCountdown(remaining);
          }
        }
        showMessage(error.message, 'error');
        checkInButton.disabled = false;
        checkInButton.textContent = 'Th·ª≠ l·∫°i';
      }
    }

    // ---------- Entry ----------
    document.addEventListener('DOMContentLoaded', () => {
      showMessage('ƒêang t·∫£i c·∫•u h√¨nh bu·ªïi h·ªçc...', 'loading');
      fetchConfig()
        .then(initializeApp)
        .catch(error => {
          showMessage(error.message, 'error');
          sessionTitle.textContent = 'L·ªói c·∫•u h√¨nh';
          checkInButton.textContent = 'Kh√¥ng th·ªÉ ƒëi·ªÉm danh';
        });
    });
  </script>
</body>
</html>
